{% extends "base.html" %}
{% block content %}
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
</head>
<!-- feed of friends workouts -->
<!-- feed of friends earned awards -->
<!--  workout will have a 3 dots icon that allows user to view profile, all their activities, and current challenges-->
<div id="userContainer"></div>

<template data-user-template>
  <div class="card text-white bg-dark p-3" data-user-cards-container>
    <div class="card-body d-flex flex-row align-items-center justify-content-between flex-wrap gap-3">
      <div class="profile_image" image-tag></div>
      <div class="name" name-tag></div>

      <div class="dropdown">
        <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
          Dropdown button
        </button>
        <ul class="dropdown-menu">
          <li><button class="dropdown-item view_user" view-user-tag>Profile</button></li>
          <li><button class="dropdown-item view_activites" view-activites-tag>Activities</button></li>
          <li><button class="dropdown-item view_challenges" view-challenges-tag>Current Challenges</button></li>
        </ul>
      </div>

      <div class="workout_stats" workout-stats-container>
        <div class="card-container d-flex flex-column">
          <h2 class="title" title-data></h2>
          <h3 class="exercise" exercise-data></h3>
          <div class="duration-row d-flex gap-2">
            <h4 class="hours" hours-data></h4>
            <h4 class="minutes" minutes-data></h4>
            <h4 class="seconds" seconds-data></h4>
          </div>
          <h5 class="datetime" datetime-data></h5>
        </div>
      </div>

    </div>
  </div>
</template>

<script>
    //query selector is used for creating multiple cards and mapping
    const userCardTemplate = document.querySelector("[data-user-template]")
    const userCardContainer = document.getElementById("userContainer")

    let users = []
    fetch("/api_feed")
    .then(response => response.json())
    .then(data => {
        const users = data.users; // âœ… now using 'users' from the response

      users.forEach(user => {
        user.workouts.forEach(workout => {
            const card = userCardTemplate.content.cloneNode(true).children[0]
            //code to display the image
            const imageContainer= card.querySelector("[image-tag]");
            const img = document.createElement("img");
            const profile_pic = user.image_file;
            const fullName = `${user.first_name} ${user.last_name}`;

            img.src = profile_pic; 
            img.alt = fullName;
            img.style.width = "50px";
            img.style.height = "50px";
            img.style.objectFit = "cover";
            img.classList.add("rounded-circle");

            imageContainer.appendChild(img);

            //code to display name 
            const nameContainer = card.querySelector("[name-tag]");
            const nameElement = document.createElement("p");  // use 'p', 'h5', 'span', etc.
            nameElement.textContent = fullName;
            nameContainer.appendChild(nameElement);

            //code for main workout elements 
            const exercise = card.querySelector("[exercise-data]")
            const title = card.querySelector("[title-data]")
            const hours = card.querySelector("[hours-data]")
            const minutes = card.querySelector("[minutes-data]")
            const seconds = card.querySelector("[seconds-data]")
            const datetime = card.querySelector("[datetime-data]")

            exercise.textContent = workout.exercise;
            title.textContent = workout.workout_title;

            //convert to user's timezone
            const utcTimeString = workout.date
            const localTime = new Date(utcTimeString);
            const formatted = localTime.toLocaleString(undefined, {
            year: 'numeric', 
            month: '2-digit', 
            day: '2-digit',
            hour: '2-digit', 
            minute: '2-digit'
            });
            datetime.textContent = formatted;
            
            // Convert duration from minutes to h/m/s
            const totalSeconds = Math.round(workout.duration_minutes * 60);
            const h = Math.floor(totalSeconds / 3600);
            const m = Math.floor((totalSeconds % 3600) / 60);
            const s = totalSeconds % 60;
            if (h > 0) {
              hours.innerHTML = `<span class="number">${h}</span><span class="unit"> hr</span>`;
            } else {
              hours.style.display = "none";
            }

            if (m > 0) {
              minutes.innerHTML = `<span class="number">${m}</span><span class="unit"> min</span>`;
            } else {
              minutes.style.display = "none";
            }

            if (s > 0) {
              seconds.innerHTML = `<span class="number">${s}</span><span class="unit"> sec</span>`;
            } else {
              seconds.style.display = "none";
            }
  
            userCardContainer.appendChild(card);
    

        })
    })
    })
</script>
{% endblock %}